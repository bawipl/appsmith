SELECT DATE_TRUNC('month', "source"."paybackdate") AS "Payback date", SUM("source"."amountend"::numeric) - SUM("source"."amountstart"::numeric) AS "Profit"
FROM (SELECT "source"."amountend"::numeric AS "amountend", "source"."contractdata" AS "contractdata", "source"."amountstart"::numeric AS "amountstart", "source"."counterparty" AS "counterparty", "source"."startdate" AS "startdate", "source"."contact" AS "contact", "source"."enddate" AS "enddate", "source"."currency" AS "currency", "source"."APR" AS "APR", "source"."isfinished" AS "isfinished", "source"."lendcontractID" AS "lendcontractID", "source"."paybackdate" AS "paybackdate", "source"."isliquidated" AS "isliquidated", "source"."owner" AS "owner", "source"."platform" AS "platform", "source"."Profit" AS "Profit", "source"."duration" AS "duration", "source"."APY" AS "APY", "source"."currencies__via__currency__shortcode" AS "currencies__via__currency__shortcode" FROM (SELECT "public"."hodlhodllend"."amountend"::numeric AS "amountend", "public"."hodlhodllend"."contractdata" AS "contractdata", "public"."hodlhodllend"."amountstart"::numeric AS "amountstart", "public"."hodlhodllend"."counterparty" AS "counterparty", "public"."hodlhodllend"."startdate" AS "startdate", "public"."hodlhodllend"."contact" AS "contact", "public"."hodlhodllend"."enddate" AS "enddate", "public"."hodlhodllend"."currency" AS "currency", "public"."hodlhodllend"."APR" AS "APR", "public"."hodlhodllend"."isfinished" AS "isfinished", "public"."hodlhodllend"."lendcontractID" AS "lendcontractID", "public"."hodlhodllend"."paybackdate" AS "paybackdate", "public"."hodlhodllend"."isliquidated" AS "isliquidated", "public"."hodlhodllend"."owner" AS "owner", "public"."hodlhodllend"."platform" AS "platform", "public"."hodlhodllend"."amountend"::numeric - "public"."hodlhodllend"."amountstart"::numeric AS "Profit", CAST(extract(day from (DATE_TRUNC('day', "public"."hodlhodllend"."paybackdate") - DATE_TRUNC('day', "public"."hodlhodllend"."startdate"))) AS integer) AS "duration", CAST((CAST("public"."hodlhodllend"."amountend"::numeric - "public"."hodlhodllend"."amountstart"::numeric AS float) / CASE WHEN "public"."hodlhodllend"."amountstart"::numeric = 0 THEN NULL ELSE "public"."hodlhodllend"."amountstart"::numeric END) * 100 * 365 AS float) / CASE WHEN CAST(extract(day from (DATE_TRUNC('day', "public"."hodlhodllend"."paybackdate") - DATE_TRUNC('day', "public"."hodlhodllend"."startdate"))) AS integer) = 0 THEN NULL ELSE CAST(extract(day from (DATE_TRUNC('day', "public"."hodlhodllend"."paybackdate") - DATE_TRUNC('day', "public"."hodlhodllend"."startdate"))) AS integer) END AS "APY", "currencies__via__currency"."shortcode" AS "currencies__via__currency__shortcode", "currencies__via__currency"."ID" AS "currencies__via__currency__ID" FROM "public"."hodlhodllend"
LEFT JOIN "public"."currencies" AS "currencies__via__currency" ON "public"."hodlhodllend"."currency" = "currencies__via__currency"."ID"
WHERE TRUE = "public"."hodlhodllend"."isfinished") AS "source") AS "source"
GROUP BY DATE_TRUNC('month', "source"."paybackdate")
ORDER BY DATE_TRUNC('month', "source"."paybackdate") DESC