{
  "gitSyncId": "67a2400b3e12e107acd1a186_9c7289b0-138e-4ac8-9003-74763f14619c",
  "id": "Operation summary_OperationsQuery",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH in_leg AS (\n  SELECT\n    id                        AS loan_id,\n    (date)                 AS ts_in,\n    (amount)               AS amt_in,\n    (owner_id)             AS in_owner,\n    (currency_id)          AS in_currency_id,\n    (platform_id)          AS in_platform_id,\n\tdescription              AS in_description\n  FROM cashoperations\n  WHERE direction = 'in'\n),\nout_leg AS (\n  SELECT\n    id                        AS loan_id,\n    (date)                 AS ts_out,\n   (amount)               AS amt_out,\n    (owner_id)             AS out_owner,\n    (currency_id)          AS out_currency_id,\n    (platform_id)          AS out_platform_id,\n\tdescription  AS out_descripion\n  FROM cashoperations\n  WHERE direction = 'out'\n),\npairs AS (                                    -- ◀︎ remove duplicate loan_id\n  SELECT\n    co.loan_id,\n    COALESCE(i.ts_in, o.ts_out) AS op_date,\n\n    /* in-leg columns (no loan_id) */\n    i.ts_in,\n    i.amt_in,\n    i.in_owner,\n    i.in_currency_id,\n    i.in_platform_id,\n\t  i.in_description,\n\n    /* out-leg columns (no loan_id) */\n    o.ts_out,\n    o.amt_out,\n    o.out_owner,\n    o.out_currency_id,\n    o.out_platform_id\n\n  FROM (SELECT DISTINCT id AS loan_id FROM cashoperations) co\n  LEFT JOIN in_leg  i ON i.loan_id = co.loan_id\n  LEFT JOIN out_leg o ON o.loan_id = co.loan_id\n  WHERE {{Owner.selectedOptionValue}} IN (i.in_owner, o.out_owner)\n),\nx AS (                                         -- names / shortcodes\n  SELECT\n    pr.*,\n    c_in.shortcode   AS in_currency,\n    c_out.shortcode  AS out_currency,\n    p_in.name        AS in_platform,\n    p_out.name       AS out_platform\n  FROM pairs pr\n  LEFT JOIN currencies c_in  ON c_in.\"ID\" = pr.in_currency_id\n  LEFT JOIN currencies c_out ON c_out.\"ID\" = pr.out_currency_id\n  LEFT JOIN platforms  p_in  ON p_in.id    = pr.in_platform_id\n  LEFT JOIN platforms  p_out ON p_out.id   = pr.out_platform_id\n)\nSELECT\n  x.loan_id                    AS id,\n  x.op_date                    AS date,\n\tx.in_owner  AS iowner,\n\tx.out_owner as oowner,\n  x.in_description as desc,\n\n  /* from the selected owner's perspective ----------------------- */\n  CASE WHEN x.in_owner = {{Owner.selectedOptionValue}}\n       THEN x.amt_in  ELSE x.amt_out END        AS amount_in,\n  CASE WHEN x.in_owner = {{Owner.selectedOptionValue}}\n       THEN x.in_currency ELSE x.out_currency END AS currency_in,\n \n      x.in_platform AS platform_in,\n\n  CASE WHEN x.out_owner = {{Owner.selectedOptionValue}}\n       THEN x.amt_out ELSE x.amt_in END         AS amount_out,\n  CASE WHEN x.out_owner = {{Owner.selectedOptionValue}}\n       THEN x.out_currency ELSE x.in_currency END AS currency_out,\n  \n       x.out_platform AS platform_out,\n\n  CASE\n    WHEN x.in_currency_id <> x.out_currency_id THEN\n         'Currency exchange from ' || x.out_currency || ' to ' || x.in_currency ||\n         ' at rate ' ||\n         ROUND((x.amt_in / NULLIF(x.amt_out,0))::numeric, 6)\n\n    WHEN x.in_owner <> x.out_owner THEN\n         CASE WHEN x.in_owner = {{Owner.selectedOptionValue}}\n              THEN 'Incoming transfer from ' || x.out_owner\n              ELSE 'Outgoing transfer to '  || x.in_owner\n         END\n    ELSE\n         'Internal transfer between platforms'\n  END AS details\nFROM x\nORDER BY x.op_date DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "WieczorekAssets",
      "isAutoGenerated": false,
      "name": "WieczorekAssets",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "executeOnLoad": false,
    "name": "OperationsQuery",
    "pageId": "Operation summary",
    "userSetOnLoad": true
  }
}