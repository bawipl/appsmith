{
  "gitSyncId": "67a2400b3e12e107acd1a186_asset-swap-execute",
  "id": "Asset Swap_ExecuteSwap",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- Asset Swap Transaction with Exchange Rate\n-- Creates 4 cash operations: 2 for each leg of the swap\n-- Includes exchange rate calculation in description\n\nWITH\nswap_params AS (\n  SELECT \n    {{Amount1Input.text}}::DOUBLE PRECISION AS amount1,\n    {{Amount2Input.text}}::DOUBLE PRECISION AS amount2,\n    CASE \n      WHEN {{Amount1Input.text}}::DOUBLE PRECISION > 0 \n      THEN ROUND(({{Amount2Input.text}}::DOUBLE PRECISION / {{Amount1Input.text}}::DOUBLE PRECISION)::NUMERIC, 8)\n      ELSE 0 \n    END AS rate_1_to_2,\n    CASE \n      WHEN {{Amount2Input.text}}::DOUBLE PRECISION > 0 \n      THEN ROUND(({{Amount1Input.text}}::DOUBLE PRECISION / {{Amount2Input.text}}::DOUBLE PRECISION)::NUMERIC, 8)\n      ELSE 0 \n    END AS rate_2_to_1\n),\nswap_group AS (\n  SELECT gen_random_uuid() AS group_id\n),\nleg1_out AS (\n  INSERT INTO cashoperations (\n    id, direction, owner_id, date,\n    platform_id, currency_id, amount,\n    fee, description, operation_group\n  )\n  SELECT\n    nextval('cashoperations_id_seq'),\n    'out',\n    {{Owner1Select.selectedOptionValue}}::char(5),\n    CURRENT_TIMESTAMP,\n    {{Platform1Select.selectedOptionValue}}::INTEGER,\n    {{Currency1Select.selectedOptionValue}}::INTEGER,\n    sp.amount1,\n    0,\n    'Swap OUT: ' || sp.amount1 || ' ' || {{Currency1Select.selectedOptionLabel}} || ' to ' || {{Owner2Select.selectedOptionLabel}} || ' @ rate ' || sp.rate_1_to_2 || ' (1 ' || {{Currency1Select.selectedOptionLabel}} || ' = ' || sp.rate_1_to_2 || ' ' || {{Currency2Select.selectedOptionLabel}} || ')',\n    (SELECT group_id FROM swap_group)\n  FROM swap_params sp\n  RETURNING id\n),\nleg1_in AS (\n  INSERT INTO cashoperations (\n    id, direction, owner_id, date,\n    platform_id, currency_id, amount,\n    fee, description, operation_group\n  )\n  SELECT\n    nextval('cashoperations_id_seq'),\n    'in',\n    {{Owner2Select.selectedOptionValue}}::char(5),\n    CURRENT_TIMESTAMP,\n    {{Platform1Select.selectedOptionValue}}::INTEGER,\n    {{Currency1Select.selectedOptionValue}}::INTEGER,\n    sp.amount1,\n    0,\n    'Swap IN: ' || sp.amount1 || ' ' || {{Currency1Select.selectedOptionLabel}} || ' from ' || {{Owner1Select.selectedOptionLabel}} || ' @ rate ' || sp.rate_2_to_1 || ' (1 ' || {{Currency2Select.selectedOptionLabel}} || ' = ' || sp.rate_2_to_1 || ' ' || {{Currency1Select.selectedOptionLabel}} || ')',\n    (SELECT group_id FROM swap_group)\n  FROM swap_params sp\n  RETURNING id\n),\nleg2_out AS (\n  INSERT INTO cashoperations (\n    id, direction, owner_id, date,\n    platform_id, currency_id, amount,\n    fee, description, operation_group\n  )\n  SELECT\n    nextval('cashoperations_id_seq'),\n    'out',\n    {{Owner2Select.selectedOptionValue}}::char(5),\n    CURRENT_TIMESTAMP,\n    {{Platform2Select.selectedOptionValue}}::INTEGER,\n    {{Currency2Select.selectedOptionValue}}::INTEGER,\n    sp.amount2,\n    0,\n    'Swap OUT: ' || sp.amount2 || ' ' || {{Currency2Select.selectedOptionLabel}} || ' to ' || {{Owner1Select.selectedOptionLabel}} || ' @ rate ' || sp.rate_2_to_1 || ' (1 ' || {{Currency2Select.selectedOptionLabel}} || ' = ' || sp.rate_2_to_1 || ' ' || {{Currency1Select.selectedOptionLabel}} || ')',\n    (SELECT group_id FROM swap_group)\n  FROM swap_params sp\n  RETURNING id\n),\nleg2_in AS (\n  INSERT INTO cashoperations (\n    id, direction, owner_id, date,\n    platform_id, currency_id, amount,\n    fee, description, operation_group\n  )\n  SELECT\n    nextval('cashoperations_id_seq'),\n    'in',\n    {{Owner1Select.selectedOptionValue}}::char(5),\n    CURRENT_TIMESTAMP,\n    {{Platform2Select.selectedOptionValue}}::INTEGER,\n    {{Currency2Select.selectedOptionValue}}::INTEGER,\n    sp.amount2,\n    0,\n    'Swap IN: ' || sp.amount2 || ' ' || {{Currency2Select.selectedOptionLabel}} || ' from ' || {{Owner2Select.selectedOptionLabel}} || ' @ rate ' || sp.rate_1_to_2 || ' (1 ' || {{Currency1Select.selectedOptionLabel}} || ' = ' || sp.rate_1_to_2 || ' ' || {{Currency2Select.selectedOptionLabel}} || ')',\n    (SELECT group_id FROM swap_group)\n  FROM swap_params sp\n  RETURNING id\n)\nSELECT \n  (SELECT group_id FROM swap_group) AS swap_id,\n  (SELECT id FROM leg1_out) AS leg1_out_id,\n  (SELECT id FROM leg1_in) AS leg1_in_id,\n  (SELECT id FROM leg2_out) AS leg2_out_id,\n  (SELECT id FROM leg2_in) AS leg2_in_id,\n  (SELECT rate_1_to_2 FROM swap_params) AS exchange_rate;",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": true,
    "datasource": {
      "id": "WieczorekAssets",
      "isAutoGenerated": false,
      "name": "WieczorekAssets",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "executeOnLoad": false,
    "name": "ExecuteSwap",
    "pageId": "Asset Swap",
    "userSetOnLoad": false
  }
}
