SELECT
  p.name                          AS platform,
  c.shortcode                     AS currency,

  /* raw balance in original units */
  SUM(CASE WHEN co.direction = 'in' THEN co.amount
           ELSE -co.amount END)   AS cash_balance,

  /* FX rate */
  COALESCE(r.rate_to_usd, 0)      AS rate_to_usd,

  /* numeric value in USD (kept for ORDER BY) */
  SUM(CASE WHEN co.direction = 'in' THEN co.amount
           ELSE -co.amount END) * COALESCE(r.rate_to_usd, 0)  AS usd_value_raw,

  /* prettified USD text with thousands-separator and 2 decimals */
  to_char(
      SUM(CASE WHEN co.direction = 'in' THEN co.amount
               ELSE -co.amount END) * COALESCE(r.rate_to_usd, 0),
      'FM999,999,999,990.00'
  ) || ' USD'                      AS usd_value
FROM cashoperations co
JOIN currencies  c ON c."ID" = co.currency_id
JOIN platforms   p ON p.id   = co.platform_id
LEFT JOIN fx_rates r ON r.currency_id = c."ID"
WHERE co.owner_id = {{appsmith.store.owner}}
GROUP BY p.name, c.shortcode, r.rate_to_usd
HAVING
     ABS( SUM(CASE WHEN co.direction = 'in' THEN co.amount
               ELSE -co.amount END) * COALESCE(r.rate_to_usd, 0)) >= 1     -- keep only â‰¥1 USD
ORDER BY usd_value_raw DESC;


